<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Upload de Dados - Sistema de Ranking Premium">
    <title>Upload de Dados | Central de Controle</title>

    <!-- Styles -->
    <link rel="stylesheet" href="../styles.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- SheetJS & Supabase -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" type="image/png" href="../favicon.png">

    <style>
        /* Page Specific Styles */
        .upload-page-wrapper {
            background:
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.2) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.15) 0px, transparent 50%),
                var(--bg-body);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Center vertically */
            padding: 2rem 1rem;
            /* Add some safety padding */
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-lg);
            padding: 2rem;
            /* Reduced from 2.5rem */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }

        .upload-header {
            text-align: center;
            margin-bottom: 1.5rem;
            /* Reduced from 3rem */
        }

        .upload-title {
            font-size: 2rem;
            /* Reduced from 2.5rem */
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            /* Fix lint */
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
        }

        .upload-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .upload-zone {
            border: 2px dashed rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-md);
            padding: 2.5rem 1.5rem;
            /* Reduced from 4rem 2rem */
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: rgba(30, 41, 59, 0.2);
            cursor: pointer;
            overflow: hidden;
        }

        .upload-zone:hover,
        .upload-zone.drag-over {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
            transform: scale(1.01);
        }

        .upload-zone-icon {
            font-size: 3rem;
            /* Reduced from 4rem */
            color: var(--text-muted);
            margin-bottom: 1rem;
            /* Reduced from 1.5rem */
            transition: all 0.3s ease;
        }

        .upload-zone:hover .upload-zone-icon {
            color: var(--accent-blue);
            transform: translateY(-5px);
        }

        .upload-zone h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .upload-zone p {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* Action Buttons */
        .btn-upload {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1.5rem;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
        }

        .btn-upload:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-back {
            position: absolute;
            top: 2rem;
            left: 2rem;
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: color 0.2s;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
        }

        .btn-back:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Instructions Accordion */
        .instructions-toggle {
            color: var(--text-muted);
            font-size: 0.9rem;
            background: none;
            border: none;
            cursor: pointer;
            margin: 1.5rem auto 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }

        .instructions-toggle:hover {
            color: var(--text-secondary);
        }

        .instructions-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            text-align: left;
            margin-top: 1rem;
        }

        .instructions-panel.open {
            max-height: 500px;
            /* arbitrary large enough height */
        }

        .instructions-list {
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            list-style: none;
        }

        .instructions-list li {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
            position: relative;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .instructions-list li::before {
            content: '‚Ä¢';
            color: var(--accent-blue);
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        /* Status Panels */
        .status-card {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideUp 0.3s ease-out;
        }

        .status-card.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .status-card.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-card.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 99px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent-blue);
            width: 0%;
            transition: width 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="upload-page-wrapper">
        <a href="../index.html" class="btn-back">
            <span>‚Üê</span> Voltar ao Ranking
        </a>

        <div class="container" style="max-width: 600px;">
            <div class="glass-card">
                <div class="upload-header">
                    <h1 class="upload-title">Importar Dados</h1>
                    <p class="upload-subtitle">Fa√ßa o upload do seu relat√≥rio Excel (.xlsx) para atualizar o ranking
                        automaticamente.</p>
                </div>

                <div id="upload-area" class="upload-zone">
                    <div class="upload-zone-icon">‚òÅÔ∏è</div>
                    <h3 id="drop-text-title">Arraste o arquivo aqui</h3>
                    <p id="drop-text-desc">ou clique para selecionar do seu computador</p>
                    <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls">
                </div>

                <!-- Info Card (After selection) -->
                <div id="file-info" class="status-card info hidden">
                    <div style="font-size: 1.5rem;">üìÑ</div>
                    <div style="flex: 1;">
                        <strong id="file-name"
                            style="color: var(--text-primary); display: block;">nome-do-arquivo.xlsx</strong>
                        <span id="file-details" style="font-size: 0.8rem; color: var(--text-secondary);">25 KB</span>
                    </div>
                    <div style="font-size: 1.2rem; color: var(--accent-blue);">‚úì</div>
                </div>

                <!-- Progress Section -->
                <div id="progress-section" class="hidden" style="margin-top: 1.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem;">
                        <span id="progress-text" style="color: var(--text-primary);">Processando...</span>
                        <span id="progress-percentage" style="color: var(--accent-blue);">0%</span>
                    </div>
                    <div class="progress-container">
                        <div id="progress-fill" class="progress-bar-fill"></div>
                    </div>
                </div>

                <!-- Main Action Button -->
                <button id="upload-btn" class="btn-upload hidden">
                    <span>üöÄ</span> Processar e Atualizar Ranking
                </button>

                <!-- Success State -->
                <div id="success-message" class="status-card success hidden">
                    <div style="font-size: 1.5rem;">‚úÖ</div>
                    <div>
                        <strong style="color: #34d399; display: block;">Sucesso!</strong>
                        <span id="success-details" style="color: var(--text-secondary); font-size: 0.9rem;">Dados
                            processados.</span>
                    </div>
                </div>

                <!-- Error State -->
                <div id="error-message" class="status-card error hidden">
                    <div style="font-size: 1.5rem;">‚ùå</div>
                    <div>
                        <strong style="color: #f87171; display: block;">Erro</strong>
                        <span id="error-details" style="color: var(--text-secondary); font-size: 0.9rem;">Algo deu
                            errado.</span>
                    </div>
                </div>

                <!-- Tech Details / Manual -->
                <button id="toggle-instructions" class="instructions-toggle">
                    <span>‚ÑπÔ∏è</span> Ver requisitos do arquivo
                </button>
                <div id="instructions-panel" class="instructions-panel">
                    <ul class="instructions-list">
                        <li>Arquivo deve ser formato <strong>.xlsx</strong> ou <strong>.xls</strong></li>
                        <li>Deve conter as colunas obrigat√≥rias (ex: data_do_periodo, id_da_pessoa_entregadora)</li>
                        <li>Os pontos ser√£o recalculados automaticamente com base nas regras</li>
                        <li>O ranking √© atualizado em tempo real ap√≥s o sucesso</li>
                    </ul>
                </div>

            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        // Import paths updated to go up one level
        import { SupabaseClient } from '../api-client.js';
        import { processarTodosOsTurnos } from '../ranking-calculator.js';

        // Configura√ß√£o do Supabase
        const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
        const SUPABASE_SERVICE_ROLE_KEY = import.meta.env.VITE_SUPABASE_SERVICE_ROLE_KEY;

        const EXCEL_COLUMNS = [
            'data_do_periodo', 'periodo', 'duracao_do_periodo', 'numero_minimo_de_entregadores_regulares_na_escala',
            'tag', 'id_da_pessoa_entregadora', 'pessoa_entregadora', 'praca', 'sub_praca', 'origem',
            'tempo_disponivel_escalado', 'tempo_disponivel_absoluto', 'numero_de_corridas_ofertadas',
            'numero_de_corridas_aceitas', 'numero_de_corridas_rejeitadas', 'numero_de_corridas_completadas',
            'numero_de_corridas_canceladas_pela_pessoa_entregadora', 'numero_de_pedidos_aceitos_e_concluidos',
            'soma_das_taxas_das_corridas_aceitas'
        ];

        let selectedFile = null;
        let parsedData = null;
        let supabaseClient = null;

        // Elementos DOM
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const fileDetails = document.getElementById('file-details');
        const uploadBtn = document.getElementById('upload-btn');
        const progressSection = document.getElementById('progress-section');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const progressPercentage = document.getElementById('progress-percentage');
        const successMessage = document.getElementById('success-message');
        const successDetails = document.getElementById('success-details');
        const errorMessage = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const dropTextTitle = document.getElementById('drop-text-title');

        // Instructions Toggle
        const toggleInstructionsBtn = document.getElementById('toggle-instructions');
        const instructionsPanel = document.getElementById('instructions-panel');

        toggleInstructionsBtn.addEventListener('click', () => {
            instructionsPanel.classList.toggle('open');
        });


        /** Initialization */
        function inicializar() {
            if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
                mostrarErro('Configura√ß√£o incompleta env vars. Verifique VITE_SUPABASE_URL.');
                uploadArea.style.opacity = '0.5';
                uploadArea.style.pointerEvents = 'none';
                return;
            }

            supabaseClient = SupabaseClient.initSupabase(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

            // Listeners
            uploadArea.addEventListener('click', (e) => {
                // Avoid double trigger if clicking input
                if (e.target !== fileInput) fileInput.click();
            });

            fileInput.addEventListener('change', handleFileSelect);
            uploadBtn.addEventListener('click', processarEEnviar);

            // Drag & Drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
                dropTextTitle.textContent = "Solte para enviar";
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
                dropTextTitle.textContent = "Arraste o arquivo aqui";
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                dropTextTitle.textContent = "Arraste o arquivo aqui";

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect({ target: { files } });
                }
            });
        }

        async function handleFileSelect(event) {
            resetStates();
            const file = event.target.files[0];
            if (!file) return;

            selectedFile = file;

            // UI Feedback
            fileName.textContent = file.name;
            fileDetails.textContent = `${(file.size / 1024).toFixed(1)} KB`;
            fileInfo.classList.remove('hidden');

            try {
                // Simples pr√©-processamento para UX visual imediata
                dropTextTitle.textContent = "Arquivo selecionado!";
                uploadArea.style.borderColor = "var(--accent-blue)";

                await lerEParsearExcel(file);
                // Se der certo, mostra bot√£o
                uploadBtn.classList.remove('hidden');
                // Scroll suave at√© o bot√£o
                setTimeout(() => uploadBtn.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);

            } catch (error) {
                console.error(error);
                mostrarErro(error.message);
            }
        }

        async function lerEParsearExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        let jsonData = XLSX.utils.sheet_to_json(worksheet);

                        // Normaliza√ß√£o (igual ao original)
                            // Normaliza√ß√£o de Datas
                        jsonData = jsonData.map(row => {
                            if (row.data_do_periodo instanceof Date) {
                                // SheetJS normalmente define datas como UTC meia-noite
                                // Usamos m√©todos UTC para extrair a data exata sem influ√™ncia do fuso hor√°rio local
                                const d = row.data_do_periodo;
                                const year = d.getUTCFullYear();
                                const month = String(d.getUTCMonth() + 1).padStart(2, '0');
                                const day = String(d.getUTCDate()).padStart(2, '0');
                                row.data_do_periodo = `${year}-${month}-${day}`;
                            } else if (typeof row.data_do_periodo === 'number') {
                                // Excel serial date (dias desde 1900)
                                // Ajuste padr√£o para JS Date
                                const date = new Date(Math.round((row.data_do_periodo - 25569) * 86400 * 1000));
                                const year = date.getUTCFullYear();
                                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                                const day = String(date.getUTCDate()).padStart(2, '0');
                                row.data_do_periodo = `${year}-${month}-${day}`;
                            }

                            const timeColumns = ['duracao_do_periodo', 'tempo_disponivel_escalado', 'tempo_disponivel_absoluto'];
                            timeColumns.forEach(col => {
                                if (row[col] instanceof Date) {
                                    const d = row[col];
                                    const h = d.getUTCHours().toString().padStart(2, '0');
                                    const m = d.getUTCMinutes().toString().padStart(2, '0');
                                    const s = d.getUTCSeconds().toString().padStart(2, '0');
                                    row[col] = `${h}:${m}:${s}`;
                                }
                            });
                            return row;
                        });

                        if (jsonData.length === 0) throw new Error('Planilha vazia');

                        // Valida√ß√£o de colunas
                        const firstRow = jsonData[0];
                        const foundCols = Object.keys(firstRow);
                        const missingCols = EXCEL_COLUMNS.filter(col => !foundCols.includes(col));
                        if (missingCols.length > 0) {
                            console.warn('Colunas faltando:', missingCols);
                        }

                        parsedData = jsonData;
                        fileDetails.textContent += ` ‚Ä¢ ${jsonData.length} linhas`;
                        resolve(jsonData);
                    } catch (error) {
                        reject(new Error('Falha ao ler Excel: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('Erro de leitura de arquivo'));
                reader.readAsArrayBuffer(file);
            });
        }

        async function processarEEnviar() {
            if (!parsedData || parsedData.length === 0) return;

            resetStates();
            fileInfo.classList.remove('hidden'); // Manter info file visivel
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = `<span>‚è≥</span> Processando...`;
            progressSection.classList.remove('hidden');

            try {
                atualizarProgresso(10, 'Iniciando c√°lculos...');

                // Simulating a tiny delay for UX so user sees "Started"
                await new Promise(r => setTimeout(r, 300));

                atualizarProgresso(30, 'Calculando pontua√ß√µes...');
                const turnosProcessados = processarTodosOsTurnos(parsedData);

                atualizarProgresso(50, 'Preparando envio...');
                const turnosParaInserir = turnosProcessados.map(turno => ({
                    data_do_periodo: turno.data_do_periodo,
                    periodo: turno.periodo || null,
                    duracao_do_periodo: turno.duracao_do_periodo || null,
                    numero_minimo_de_entregadores_regulares_na_escala: turno.numero_minimo_de_entregadores_regulares_na_escala || null,
                    tag: turno.tag || null,
                    id_da_pessoa_entregadora: turno.id_da_pessoa_entregadora,
                    pessoa_entregadora: turno.pessoa_entregadora,
                    praca: turno.praca || null,
                    sub_praca: turno.sub_praca || null,
                    origem: turno.origem || null,
                    tempo_disponivel_escalado: turno.tempo_disponivel_escalado || null,
                    tempo_disponivel_absoluto: turno.tempo_disponivel_absoluto || null,
                    numero_de_corridas_ofertadas: turno.numero_de_corridas_ofertadas || 0,
                    numero_de_corridas_aceitas: turno.numero_de_corridas_aceitas || 0,
                    numero_de_corridas_rejeitadas: turno.numero_de_corridas_rejeitadas || 0,
                    numero_de_corridas_completadas: turno.numero_de_corridas_completadas || 0,
                    numero_de_corridas_canceladas_pela_pessoa_entregadora: turno.numero_de_corridas_canceladas_pela_pessoa_entregadora || 0,
                    numero_de_pedidos_aceitos_e_concluidos: turno.numero_de_pedidos_aceitos_e_concluidos || 0,
                    soma_das_taxas_das_corridas_aceitas: turno.soma_das_taxas_das_corridas_aceitas || 0,
                    percentual_tempo_online: turno.percentual_tempo_online,
                    pontos_entregas: turno.pontos_entregas,
                    bonus_90_online: turno.bonus_90_online,
                    bonus_data_especial: turno.bonus_data_especial,
                    total_pontos_turno: turno.total_pontos_turno,
                    entregas_no_dia: turno.entregas_no_dia,
                    bonus_meta_diaria: turno.bonus_meta_diaria,
                    total_pontos_final: turno.total_pontos_final
                }));

                atualizarProgresso(70, `Enviando ${turnosParaInserir.length} registros...`);
                await SupabaseClient.uploadCompleto(turnosParaInserir);

                atualizarProgresso(100, 'Conclu√≠do!');

                setTimeout(() => {
                    mostrarSucesso(`${turnosParaInserir.length} turnos atualizados!`);
                    uploadBtn.innerHTML = `<span>üöÄ</span> Processar Novamente`;
                    uploadBtn.disabled = false;
                    progressSection.classList.add('hidden');
                }, 800);

            } catch (error) {
                console.error(error);
                mostrarErro(error.message);
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `<span>üöÄ</span> Tentar Novamente`;
                progressSection.classList.add('hidden');
            }
        }

        // Helpers UI
        function atualizarProgresso(percent, text) {
            progressFill.style.width = `${percent}%`;
            progressPercentage.textContent = `${percent}%`;
            progressText.textContent = text;
        }

        function mostrarErro(msg) {
            errorDetails.textContent = msg;
            errorMessage.classList.remove('hidden');
        }

        function mostrarSucesso(msg) {
            successDetails.textContent = msg;
            successMessage.classList.remove('hidden');
        }

        function resetStates() {
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
            progressSection.classList.add('hidden');
            uploadBtn.classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', inicializar);
    </script>
</body>

</html>